    <script>
        // Variables globales para los gráficos
        let packagesChart, earningsChart, tripsChart, topProductsChart;

        $(document).ready(function() {
            // Cargar camiones disponibles
            loadTrucks();

            // Cargar datos iniciales
            loadData();

            // Configurar evento para filtros
            $('#apply-filters').click(function() {
                loadData();
            });
        });

        function loadTrucks() {
            $.ajax({
                url: 'action.php?action=obtener_camiones',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    const select = $('#truck-filter');
                    select.empty();
                    select.append('<option value="">Todos los camiones</option>');

                    $.each(data, function(index, camion) {
                        select.append(`<option value="${camion}">${camion}</option>`);
                    });
                },
                error: function() {
                    console.error('Error al cargar camiones');
                }
            });
        }

        function loadData() {
            const fechaInicio = $('#start-date').val();
            const fechaFin = $('#end-date').val();
            const camion = $('#truck-filter').val();

            // Cargar datos de resumen
            $.ajax({
                url: 'action.php?action=obtener_datos_resumen',
                type: 'GET',
                data: {
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    camion: camion
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        updateSummaryCards(response.data);
                    }
                },
                error: function() {
                    console.error('Error al cargar datos de resumen');
                }
            });

            // Cargar datos para gráficos
            $.ajax({
                url: 'action.php?action=obtener_datos_graficos',
                type: 'GET',
                data: {
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    camion: camion
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        updateCharts(response.data);
                    }
                },
                error: function() {
                    console.error('Error al cargar datos para gráficos');
                }
            });
        }

        function updateSummaryCards(data) {
            $('#total-packages').text(data.totalPaquetes.toLocaleString());
            $('#total-earnings').text('Bs. ' + data.totalGanancias.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }));
            $('#total-trips').text(data.totalViajes.toLocaleString());
            $('#total-products').text(data.totalProductos.toLocaleString());
        }

        function updateCharts(data) {
            // Actualizar gráfico de paquetes y asignar a la variable global
            packagesChart = updateChart(packagesChart, 'packagesChart', 'bar',
                data.paquetes.labels, data.paquetes.data,
                '#F40009', 'Cantidad de Paquetes');

            // Actualizar gráfico de ganancias y asignar a la variable global
            earningsChart = updateChart(earningsChart, 'earningsChart', 'line',
                data.ganancias.labels, data.ganancias.data,
                '#4CAF50', 'Ganancias (Bs)', true);

            // Actualizar gráfico de viajes y asignar a la variable global
            tripsChart = updateChart(tripsChart, 'tripsChart', 'bar',
                data.viajes.labels, data.viajes.data,
                '#3498db', 'Cantidad de Viajes');

            // Actualizar gráfico de productos y asignar a la variable global
            topProductsChart = updateTopProductsChart(data.productos);
        }

        function updateChart(chartVar, canvasId, type, labels, data, color, yAxisTitle, isLine = false) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Destruir el gráfico anterior si existe
            if (chartVar) {
                chartVar.destroy();
            }

            // Configuración común
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: yAxisTitle
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            };

            // Configuración específica para gráfico de línea
            if (isLine) {
                chartVar = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            borderColor: color,
                            backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        ...commonOptions,
                        plugins: {
                            ...commonOptions.plugins,
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Bs. ' + context.raw.toLocaleString('es-ES', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        });
                                    }
                                }
                            }
                        }
                    }
                });
            }
            // Configuración para gráficos de barras
            else {
                chartVar = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: color,
                            borderColor: color,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        plugins: {
                            ...commonOptions.plugins,
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.raw.toLocaleString() +
                                            (yAxisTitle.includes('Viajes') ? ' viajes' : ' paquetes');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            return chartVar;
        }

        //grafico que muestra los productos mas vendidos
        function updateTopProductsChart(productos) {
            const ctx = document.getElementById('topProductsChart').getContext('2d');

            // Destruir el gráfico anterior si existe
            if (topProductsChart) {
                topProductsChart.destroy();
            }

            // Preparar datos
            const labels = productos.map(p => p.NOMBRE);
            const data = productos.map(p => p.cantidad);
            const backgroundColors = [
                '#F40009', '#4CAF50', '#FFC107', '#9C27B0', '#2196F3'
            ].slice(0, productos.length);

            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad Vendida'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.toLocaleString() + ' unidades';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>